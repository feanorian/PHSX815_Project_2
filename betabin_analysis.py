
"""
Name: Craig Brooks
PHSX 815 Spring 2023
Project # 2
Due Date 4/10/2023
This code to calculate log liklihood of getting the data generated by `betabin.py` and produces a plot based on the draws

 
"""

import sys
import numpy as np
import matplotlib.pyplot as plt
import csv
import pandas as pd
import seaborn as sns
import random
import matplotlib.tri as tri
from scipy.special import beta

if __name__ == "__main__":


	
	if '-f' in sys.argv:
		p = sys.argv.index('-f')
		InputFile = sys.argv[p+1]
	
	# Opens the datafile and reads it into array   
	def find_nearest(array, value):
		array = np.asarray(array)
		idx = (np.abs(array - value)).argmin()
		return array[idx]

	with open(InputFile) as file:
		table = pd.read_csv(file)
		print(table.head()) 
	
	# Arrays that store the counts of each category for all trials
	pH0_white = table['white H0'] 
	pH0_black = table['black H0']
	
	pH1_white = table['white H1'] 
	pH1_black = table['black H1']

	# alpha vectors used in experiment
	alpha_H0 = [1,2]
	alpha_H1 = [8,9]
	
	
	total = np.sum([pH0_white[0], pH0_black[0]])

	# sum of each alpha vector as input for likelihood functions
	alphaH0_sum = np.sum(alpha_H0)
	alphaH1_sum = np.sum(alpha_H1)

	# Numerator for likelihood functions that is based on sum of alpha vectors and the number of trials
	beta_H0 = beta(total, alphaH0_sum)
	beta_H1 = beta(total, alphaH1_sum)

	likelihoodr_H0 = []
	likelihoodr_H1 = []

	# Calculates likelihood of each hypothesis
	for i in range(len(table)):
		
		LHR_H0 = (beta(alpha_H1[0], alpha_H1[1]) / beta(alpha_H0[0], alpha_H0[1]))*(beta(pH0_white[i] + alpha_H0[0], total - pH0_white[i] + alpha_H0[1]) \
		/ beta(pH0_white[i] + alpha_H1[0], total - pH0_white[i] + alpha_H1[1]))
	
		LHR_H1 = (beta(alpha_H0[0], alpha_H0[1]) / beta(alpha_H1[0], alpha_H1[1]))*(beta(pH0_white[i] + alpha_H1[0], total - pH0_white[i] + alpha_H1[1]) \
		/ beta(pH0_white[i] + alpha_H0[0], total - pH0_white[i] + alpha_H0[1]))
		
		likelihoodr_H0.append(np.log10(LHR_H0))
		likelihoodr_H1.append(np.log10(LHR_H1))
	
	crit = likelihoodr_H0.index(find_nearest(likelihoodr_H0, value=0.0))
	beta = (likelihoodr_H0 == likelihoodr_H0[crit]).sum() / len(likelihoodr_H0)
	
	test = np.quantile(likelihoodr_H0, [.05, .95])
	reject = round(find_nearest(likelihoodr_H0, value=0.0), 4)
	x_95 = pH0_white[likelihoodr_H0.index(test[0])]

	textstr = '\n'.join((
	rf'.95 CL @ LLRH0 < {round(reject, 4)}',
    	rf'$\alpha$ =.05 @ x = {x_95}',
    	rf'$\beta$ = {round(beta, 4)}',
    	rf'power = {round((1-beta), 4)}'))

	
	# Plots the log-likelihood
	ax0 = sns.histplot(likelihoodr_H0,stat='probability', bins=20, element="step", color = 'blue', alpha= .5, label=rf'H0 - $\alpha = {str(alpha_H0)}$')
	ax1 = sns.histplot(likelihoodr_H1,stat='probability', bins=20, element="step", color = 'orange', alpha= .5, label=rf'H1 - $\alpha = {str(alpha_H1)}$')
	plt.xlabel('Log-Likelihood (log(P(X | H0)/ P(X| H1)))')
	plt.yscale('log')
	plt.title(rf'Log Likelihood for $\alpha = {str(alpha_H0)}$ vs $\alpha = {str(alpha_H1)}$, {total} draws')
	plt.axvline(x = find_nearest(likelihoodr_H0, value=0.0), color='r', label=rf'LH0 = LH1')
	plt.annotate(textstr, xy=(0.05, 0.65), xycoords='axes fraction')
	plt.legend()
	plt.savefig(f'LLH0_{total}')
	plt.show()
